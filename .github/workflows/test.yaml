# This file is automatically deployed from https://github.com/at-wat/.rospkg-assets.
# Please don't directly edit; update at-wat/.rospkg-assets instead.

name: build
on:
  pull_request:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env:
          - ROS_DISTRO=noetic ALPINE_VERSION=3.20
    env:
      BUILD_LOG_DIR: /tmp/build-logs
      ROS_LOG_DIR: /tmp/ros-logs
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set env
        run: echo "${{ matrix.env }}" | xargs -n1 echo | tee -a ${GITHUB_ENV}

      - name: Install gh-pr-comment
        uses: at-wat/setup-gh-pr-comment@v0
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Test
        run: |
          touch .github/workflows/test.conf
          docker run --rm \
            -e JOBS=4 \
            --env-file .github/workflows/test.env \
            -v $(pwd):/src/$(basename $(pwd)):ro \
            -v ${BUILD_LOG_DIR}:/logs \
            -v ${ROS_LOG_DIR}:/home/builder/.ros/log \
            -v $(pwd)/.packages/packages:/packages \
            ghcr.io/alpine-ros/ros-abuild:${ALPINE_VERSION}-${ROS_DISTRO}
      - name: Report success
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh-pr-comment "[${GITHUB_RUN_NUMBER}] :white_check_mark: Passed ${ROS_DISTRO} ${ALPINE_VERSION}" \
            "<details><summary>Log summary</summary>

          $(cat ${BUILD_LOG_DIR}/summary.log)
          </details>
          "
      - name: Report failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh-pr-comment "[${GITHUB_RUN_NUMBER}] :x: Failed ${ROS_DISTRO} ${ALPINE_VERSION}" \
            "<details><summary>Log summary</summary>

          $(cat ${BUILD_LOG_DIR}/summary.log)
          </details>
          "

      - name: Compress logs
        if: always()
        run: |
          cd $(dirname ${ROS_LOG_DIR})
          tar -cJf ${ROS_LOG_DIR}.tar.xz $(basename ${ROS_LOG_DIR})
      - name: Upload ROS logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ env.ROS_DISTRO }}-${{ env.ALPINE_VERSION }}.tar.xz
          path: ${ROS_LOG_DIR}.tar.xz
          retention-days: 1
